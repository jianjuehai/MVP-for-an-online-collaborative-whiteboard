# 🎨 可分享、可实时展示的 在线团队协作白板

这是一个基于 **Vue 3** 和 **Fabric.js** 构建的实时协作白板应用。支持多人在线绘图、形状绘制、属性编辑、撤销重做以及云端保存等功能。后端采用 **Koa** + **Socket.io** 实现实时同步。


## ✨ 功能特性

#### 1. 基础绘图与属性编辑

*   **🖌️ 自由绘图**：支持画笔模式，可调节颜色和粗细。
*   **🧽 橡皮擦**：支持轨迹擦除，可精准删除线条或物体。
*   **📐 形状绘制**：快速添加矩形、圆形、三角形等基础图形。
*   **⚙️ 属性编辑**：选中物体后可修改填充色、边框色及线宽。

#### 2. 实时协同与权限
*   **🔒 对象级锁**：实现细粒度的对象锁机制。当用户编辑属性或移动物体时，该物体会被锁定，其他用户无法同时操作，并能看到红色锁定框提示。
*   **🛡️ 权限管理**：区分房主（Owner）与访客（Guest）。
    *   访客模式：不同浏览器/设备访问自动分配独立身份。
    *   权限限制：访客在他人画板上可能会受到操作限制（如无法清空画布）。
*   **🤝 URL分享**：点击新建画布会生成唯一ID，点击分享可以设置密码及有效期。
*   **🤝 实时协作**：多人进入同一房间（URL ID 一致）即可实时看到对方的操作。

#### 3. 历史记录
*   **↩️ 撤销/重做**：基于 **命令模式 (Command Pattern)** 实现，记录操作指令而非全量快照。维护 `historyStack` 和 `redoStack`，支持 50 步历史记录回溯 (Ctrl+Z / Ctrl+Y)。

#### 4. 其他功能
*   **💾 持久化存储**：采用 MySQL 数据库存储画板数据，支持用户注册登录管理个人画板。
*   **📱 响应式设计**：适配移动端布局，支持触摸操作。
*   **🖼️ 图片导出**：一键将白板内容导出为 PNG 图片。

## 💡 难点攻克

**1. 无限循环更新**

**问题描述**：A 画图 -> 发送给 B -> B 渲染图形 -> B 的 Canvas 触发 object:added 事件 -> B 又发送给 A -> 死循环。

**解决方案**：引入 isReceivingRemote 互斥锁。
* 当执行远程同步代码时，将锁置为 true。
* 事件监听器检测到锁为 true 时，拦截事件，不发送 WebSocket 消息。
* 渲染完成后释放锁。

**2. 后来者数据同步**

**问题描述**：新用户进入房间时，看不到之前用户画的内容。

**解决方案**：
* 自动保存：前端实现防抖 (```debounce```) 机制，在操作停止 1秒 后自动将全量 JSON 同步至服务端内存。
* 全量拉取：新用户初始化时，先调用 HTTP 接口 (```GET /api/board/:id```) 拉取最新快照，渲染完成后再建立 WebSocket 连接。

**3. 橡皮擦的碰撞检测**

**性能难点**：橡皮擦每次移动都需遍历所有物体并做复杂几何与像素检测，极其耗时。

**优化方案**：引入 d3-quadtree 四叉树空间索引。鼠标按下时预处理所有物体，构建索引，移动时只用四叉树快速筛选包围盒内的候选物体，再做精确碰撞检测，大幅提升性能。

**4. 实时协作同步冲突**

**问题描述**：当 A 和 B 同时选中并移动同一个物体时，位置会发生跳变或覆盖。

**解决方案**：引入“短时对象锁”机制。
* **抢锁**：当前端选中物体时，通过 Socket 发送 `request-lock`。
* **后端仲裁**：Server 维护内存中的 `locks` 表，若该物体未被锁或锁已超时，则授权给请求者。
* **视觉反馈**：其他客户端收到 `object-locked` 事件后，将该物体设为不可选，并绘制红色边框。
* **自动释放**：取消选中 (blur) 或断开连接时自动释放锁。

**5. 删除冲突**

**问题描述**：A 编辑或移动一个对象，B 将其删除，此时A点击撤回。A 的操作可能报错，或者导致已删除对象“复活”。

**解决方案**：如果A修改对象后被B删除，A将无法撤回该修改操作，历史栈回退到上一个有效操作，并提醒A。A也不能通过重做恢复B删除的对象。

**6. 保存覆盖冲突**

**问题描述**：A、B 两人同时编辑同一个白板，A 先保存，B 后保存，B 的内容会覆盖 A 的内容（因全量保存）。

**解决方案**：将实时同步由全量保存改为对象级同步，只同步用户的操作指令，避免无谓覆盖。

**7. 游客与登录用户同步冲突**

**问题描述**：游客本地修改了服务器已有对象，登录后同步服务器发生冲突。

**解决方案**：游客访问他人分享的画板时，仅允许新增操作且可实时同步，不能修改已有对象。新建画板时数据仅保存在本地，登录后再同步到服务器。

## 🛠️ 技术栈

### 前端 (Frontend)
*   **Vue 3** (Composition API) - 核心框架
*   **Vite** - 构建工具
*   **Pinia** - 状态管理
*   **Vue Router** - 路由管理
*   **Fabric.js** - Canvas 绘图引擎
*   **Socket.io-client** - 实时通信客户端
*   **Element Plus** - UI 组件库

### 后端 (Backend)
*   **Node.js** - 运行环境
*   **Koa** - Web 框架
*   **Socket.io** - WebSocket 服务端
*   **MySQL** - 持久化数据存储
*   **Koa-router** - API 路由

### 部署 (DevOps)
*   **Docker** & **Docker Compose** - 容器化部署
*   **Nginx** - 静态资源托管与反向代理


## 📂 项目结构

```text
MVP-demo/
├── public/                 # 静态资源目录
├── server/                 # 后端服务代码
│   ├── db.js               # MySQL 数据库连接池
│   └── index.js            # Koa + Socket.io 服务入口
├── src/
│   ├── api/                # API 请求封装
│   │   └── board.js        # 白板相关 API (saveBoard, getBoard)
│   ├── components/         # Vue 组件
│   │   ├── PropertySidebar.vue   # 属性侧边栏 (支持移动端抽屉)
│   │   └── WhiteboardToolbar.vue # 顶部工具栏 (响应式布局)
│   ├── composables/        # 组合式函数 (Hooks)
│   │   ├── useCanvas.js    # 核心绘图逻辑 (Fabric.js 封装)
│   │   ├── useSocket.js    # WebSocket 通信与锁机制
│   │   ├── useBoardPermissions.js # 权限与锁状态管理
│   │   ├── useBoardSync.js      # 数据加载、保存与分享逻辑
│   │   └── useWhiteboardShortcuts.js  # 快捷键处理
│   ├── router/             # 路由配置
│   │   └── index.js        # 路由定义 (支持 /board/:id)
│   ├── utils/              # 工具函数
│   │   ├── clipboard.js    # 通用剪贴板操作
│   │   ├── debounce.js     # 防抖与节流函数
│   │   └── request.js      # axios 请求封装与拦截
│   ├── stores/             # Pinia 状态仓库
│   │   └── boardStore.js   # 全局状态管理 (工具、属性、加载状态)
│   ├── views/              # 页面视图
│   │   ├── Whiteboard.vue  # 白板主页面 (逻辑胶水层)
│   │   └── LogIn.vue       # 登录/注册页面
│   ├── App.vue             # 根组件
│   ├── main.js             # 入口文件
│   └── style.css           # 全局样式重置
│
├── package.json            # 项目依赖配置
└── vite.config.js          # Vite 配置文件
```

## 🤖 AI 辅助开发声明 
本项目在开发周期紧迫的情况下，采用了 AI 结对编程 模式，由我主导架构与逻辑设计，AI 辅助代码生成。

* 开发者主导
    * 系统架构设计、技术选型（Vue3 + Fabric + Socket）
    * 核心数据流设计（只传输发生变化的数据而不是整个白板的）
    * 关键难点攻克（防环锁机制、历史记录栈逻辑）
    * 前后端接口关联
    * 代码审查与重构
    * 样式美化
* AI 辅助
    * 生成 Fabric.js 的具体 API 调用代码
    * Element Plus 组件的响应式布局适配
    * socket.io接口调用
    * 通用的工具函数（防抖、节流、随机ID）
    * CSS 细节，代码优化
    * 橡皮擦的线性插值碰撞检测算法、撤销重做栈逻辑较为复杂，由 AI 提供算法原型，我负责将其适配到 Vue 的生命周期中

## 🚀 快速开始

### 本地开发 (Development)

1.  **安装依赖**
    ```bash
    npm install
    ```

2.  **启动开发环境**
    ```bash
    node server/index.js 
    #启动后端
    # 服务运行在 http://localhost:3000
    ```
    ```bash
    npm run dev / pnpm dev
    #启动前端
    # 页面运行在 http://localhost:5173
    ```

3.  **生产环境构建与运行**
    ```bash
    npm run build
    # 构建前端静态资源 (会在根目录生成 dist 文件夹)
    ```
    ```bash
    node server/index.js 
    # 页面运行在 http://localhost:3000 (自动代理 API 请求到后端)
    ```

4.  **访问**
    打开浏览器访问 `页面运行在 http://localhost:5173 (通过代理连接后端)`。会自动跳转到默认白板 `/board/default`。

## 📖 使用指南

1.  **切换工具**：点击顶部工具栏的图标切换“选择”、“画笔”或“橡皮擦”。
2.  **添加形状**：点击“形状”下拉菜单，选择矩形、圆形或三角形。
3.  **修改属性**：使用“选择”工具点击画布上的物体，侧边栏会自动弹出（移动端从底部弹出），可修改颜色和线宽。
4.  **多人协作**：点击工具栏“新建白板”创建画板，并且会随机生成唯一id。复制当前 URL 发送给朋友，可设置密码和有效期，对方打开后即可加入同一房间进行协作。
5.  **快捷键**：
    *   `V`: 选择模式
    *   `P`: 画笔模式
    *   `Delete` / `Backspace`: 删除选中物体
    *   `Ctrl + Z`: 撤销
    *   `Ctrl + Y`: 重做

## ⚠️ 注意事项

*   **数据库配置**：本项目后端依赖 MySQL 数据库。启动前请确保本地安装了 MySQL，并根据 `server/db.js` 中的配置创建好数据库（`whiteboard_db`）及相应表结构。
*   **构建部署**：生产环境建议使用 Docker Compose 同时编排 Node 服务与 Database。

## 🔮 未来规划
* **性能优化**：引入 Redis 缓存热点白板数据，减少数据库 I/O。
* **移动端优化**：进一步优化手势操作体验。